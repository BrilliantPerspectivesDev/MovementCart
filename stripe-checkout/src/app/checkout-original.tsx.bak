'use client';

import React, { useEffect, useState, useRef } from 'react';
import { useCart } from './context/CartContext';
import { useCheckout } from './hooks/useCheckout';
import { products } from './data/products';
import { usePathname } from 'next/navigation';
import Image from 'next/image';
import { Elements, CardElement, useStripe, useElements } from '@stripe/react-stripe-js';
import { loadStripe, StripeCardElementChangeEvent, StripeCardElement } from '@stripe/stripe-js';
import { CustomerInfo } from './types';
import { useGooglePlacesAutocomplete } from './hooks/useGooglePlacesAutocomplete';
import { parseAddressComponents } from './utils/addressParser';
import { Switch } from '@headlessui/react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import ScrollableContentBox from './components/ScrollableContentBox';
import PoliciesContent from './components/PoliciesContent';
import PoliciesProceduresPage, { PoliciesWithButtons } from './policies-procedures/Policypage';

// Load Stripe outside of component to avoid recreating it on renders
const stripePromise = loadStripe(process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY || '');

// Country code mapping for common countries
const COUNTRY_OPTIONS = [
  { code: 'AF', name: 'Afghanistan' },
  { code: 'AL', name: 'Albania' },
  { code: 'DZ', name: 'Algeria' },
  { code: 'AD', name: 'Andorra' },
  { code: 'AO', name: 'Angola' },
  { code: 'AG', name: 'Antigua and Barbuda' },
  { code: 'AR', name: 'Argentina' },
  { code: 'AM', name: 'Armenia' },
  { code: 'AU', name: 'Australia' },
  { code: 'AT', name: 'Austria' },
  { code: 'AZ', name: 'Azerbaijan' },
  { code: 'BS', name: 'Bahamas' },
  { code: 'BH', name: 'Bahrain' },
  { code: 'BD', name: 'Bangladesh' },
  { code: 'BB', name: 'Barbados' },
  { code: 'BY', name: 'Belarus' },
  { code: 'BE', name: 'Belgium' },
  { code: 'BZ', name: 'Belize' },
  { code: 'BJ', name: 'Benin' },
  { code: 'BT', name: 'Bhutan' },
  { code: 'BO', name: 'Bolivia' },
  { code: 'BA', name: 'Bosnia and Herzegovina' },
  { code: 'BW', name: 'Botswana' },
  { code: 'BR', name: 'Brazil' },
  { code: 'BN', name: 'Brunei' },
  { code: 'BG', name: 'Bulgaria' },
  { code: 'BF', name: 'Burkina Faso' },
  { code: 'BI', name: 'Burundi' },
  { code: 'KH', name: 'Cambodia' },
  { code: 'CM', name: 'Cameroon' },
  { code: 'CA', name: 'Canada' },
  { code: 'CV', name: 'Cape Verde' },
  { code: 'CF', name: 'Central African Republic' },
  { code: 'TD', name: 'Chad' },
  { code: 'CL', name: 'Chile' },
  { code: 'CN', name: 'China' },
  { code: 'CO', name: 'Colombia' },
  { code: 'KM', name: 'Comoros' },
  { code: 'CG', name: 'Congo' },
  { code: 'CR', name: 'Costa Rica' },
  { code: 'HR', name: 'Croatia' },
  { code: 'CU', name: 'Cuba' },
  { code: 'CY', name: 'Cyprus' },
  { code: 'CZ', name: 'Czech Republic' },
  { code: 'DK', name: 'Denmark' },
  { code: 'DJ', name: 'Djibouti' },
  { code: 'DM', name: 'Dominica' },
  { code: 'DO', name: 'Dominican Republic' },
  { code: 'EC', name: 'Ecuador' },
  { code: 'EG', name: 'Egypt' },
  { code: 'SV', name: 'El Salvador' },
  { code: 'GQ', name: 'Equatorial Guinea' },
  { code: 'ER', name: 'Eritrea' },
  { code: 'EE', name: 'Estonia' },
  { code: 'ET', name: 'Ethiopia' },
  { code: 'FJ', name: 'Fiji' },
  { code: 'FI', name: 'Finland' },
  { code: 'FR', name: 'France' },
  { code: 'GA', name: 'Gabon' },
  { code: 'GM', name: 'Gambia' },
  { code: 'GE', name: 'Georgia' },
  { code: 'DE', name: 'Germany' },
  { code: 'GH', name: 'Ghana' },
  { code: 'GR', name: 'Greece' },
  { code: 'GD', name: 'Grenada' },
  { code: 'GT', name: 'Guatemala' },
  { code: 'GN', name: 'Guinea' },
  { code: 'GW', name: 'Guinea-Bissau' },
  { code: 'GY', name: 'Guyana' },
  { code: 'HT', name: 'Haiti' },
  { code: 'HN', name: 'Honduras' },
  { code: 'HU', name: 'Hungary' },
  { code: 'IS', name: 'Iceland' },
  { code: 'IN', name: 'India' },
  { code: 'ID', name: 'Indonesia' },
  { code: 'IR', name: 'Iran' },
  { code: 'IQ', name: 'Iraq' },
  { code: 'IE', name: 'Ireland' },
  { code: 'IL', name: 'Israel' },
  { code: 'IT', name: 'Italy' },
  { code: 'JM', name: 'Jamaica' },
  { code: 'JP', name: 'Japan' },
  { code: 'JO', name: 'Jordan' },
  { code: 'KZ', name: 'Kazakhstan' },
  { code: 'KE', name: 'Kenya' },
  { code: 'KI', name: 'Kiribati' },
  { code: 'KP', name: 'North Korea' },
  { code: 'KR', name: 'South Korea' },
  { code: 'KW', name: 'Kuwait' },
  { code: 'KG', name: 'Kyrgyzstan' },
  { code: 'LA', name: 'Laos' },
  { code: 'LV', name: 'Latvia' },
  { code: 'LB', name: 'Lebanon' },
  { code: 'LS', name: 'Lesotho' },
  { code: 'LR', name: 'Liberia' },
  { code: 'LY', name: 'Libya' },
  { code: 'LI', name: 'Liechtenstein' },
  { code: 'LT', name: 'Lithuania' },
  { code: 'LU', name: 'Luxembourg' },
  { code: 'MK', name: 'North Macedonia' },
  { code: 'MG', name: 'Madagascar' },
  { code: 'MW', name: 'Malawi' },
  { code: 'MY', name: 'Malaysia' },
  { code: 'MV', name: 'Maldives' },
  { code: 'ML', name: 'Mali' },
  { code: 'MT', name: 'Malta' },
  { code: 'MH', name: 'Marshall Islands' },
  { code: 'MR', name: 'Mauritania' },
  { code: 'MU', name: 'Mauritius' },
  { code: 'MX', name: 'Mexico' },
  { code: 'FM', name: 'Micronesia' },
  { code: 'MD', name: 'Moldova' },
  { code: 'MC', name: 'Monaco' },
  { code: 'MN', name: 'Mongolia' },
  { code: 'ME', name: 'Montenegro' },
  { code: 'MA', name: 'Morocco' },
  { code: 'MZ', name: 'Mozambique' },
  { code: 'MM', name: 'Myanmar' },
  { code: 'NA', name: 'Namibia' },
  { code: 'NR', name: 'Nauru' },
  { code: 'NP', name: 'Nepal' },
  { code: 'NL', name: 'Netherlands' },
  { code: 'NZ', name: 'New Zealand' },
  { code: 'NI', name: 'Nicaragua' },
  { code: 'NE', name: 'Niger' },
  { code: 'NG', name: 'Nigeria' },
  { code: 'NO', name: 'Norway' },
  { code: 'OM', name: 'Oman' },
  { code: 'PK', name: 'Pakistan' },
  { code: 'PW', name: 'Palau' },
  { code: 'PS', name: 'Palestine' },
  { code: 'PA', name: 'Panama' },
  { code: 'PG', name: 'Papua New Guinea' },
  { code: 'PY', name: 'Paraguay' },
  { code: 'PE', name: 'Peru' },
  { code: 'PH', name: 'Philippines' },
  { code: 'PL', name: 'Poland' },
  { code: 'PT', name: 'Portugal' },
  { code: 'QA', name: 'Qatar' },
  { code: 'RO', name: 'Romania' },
  { code: 'RU', name: 'Russia' },
  { code: 'RW', name: 'Rwanda' },
  { code: 'KN', name: 'Saint Kitts and Nevis' },
  { code: 'LC', name: 'Saint Lucia' },
  { code: 'VC', name: 'Saint Vincent and the Grenadines' },
  { code: 'WS', name: 'Samoa' },
  { code: 'SM', name: 'San Marino' },
  { code: 'ST', name: 'Sao Tome and Principe' },
  { code: 'SA', name: 'Saudi Arabia' },
  { code: 'SN', name: 'Senegal' },
  { code: 'RS', name: 'Serbia' },
  { code: 'SC', name: 'Seychelles' },
  { code: 'SL', name: 'Sierra Leone' },
  { code: 'SG', name: 'Singapore' },
  { code: 'SK', name: 'Slovakia' },
  { code: 'SI', name: 'Slovenia' },
  { code: 'SB', name: 'Solomon Islands' },
  { code: 'SO', name: 'Somalia' },
  { code: 'ZA', name: 'South Africa' },
  { code: 'SS', name: 'South Sudan' },
  { code: 'ES', name: 'Spain' },
  { code: 'LK', name: 'Sri Lanka' },
  { code: 'SD', name: 'Sudan' },
  { code: 'SR', name: 'Suriname' },
  { code: 'SE', name: 'Sweden' },
  { code: 'CH', name: 'Switzerland' },
  { code: 'SY', name: 'Syria' },
  { code: 'TW', name: 'Taiwan' },
  { code: 'TJ', name: 'Tajikistan' },
  { code: 'TZ', name: 'Tanzania' },
  { code: 'TH', name: 'Thailand' },
  { code: 'TL', name: 'Timor-Leste' },
  { code: 'TG', name: 'Togo' },
  { code: 'TO', name: 'Tonga' },
  { code: 'TT', name: 'Trinidad and Tobago' },
  { code: 'TN', name: 'Tunisia' },
  { code: 'TR', name: 'Turkey' },
  { code: 'TM', name: 'Turkmenistan' },
  { code: 'TV', name: 'Tuvalu' },
  { code: 'UG', name: 'Uganda' },
  { code: 'UA', name: 'Ukraine' },
  { code: 'AE', name: 'United Arab Emirates' },
  { code: 'GB', name: 'United Kingdom' },
  { code: 'US', name: 'United States' },
  { code: 'UY', name: 'Uruguay' },
  { code: 'UZ', name: 'Uzbekistan' },
  { code: 'VU', name: 'Vanuatu' },
  { code: 'VA', name: 'Vatican City' },
  { code: 'VE', name: 'Venezuela' },
  { code: 'VN', name: 'Vietnam' },
  { code: 'YE', name: 'Yemen' },
  { code: 'ZM', name: 'Zambia' },
  { code: 'ZW', name: 'Zimbabwe' }
];

// Add US state options
const US_STATE_OPTIONS = [
  { key: 1, value: "Alabama" },
  { key: 2, value: "Alaska" },
  { key: 3, value: "AE" },
  { key: 4, value: "AP" },
  { key: 5, value: "Arizona" },
  { key: 6, value: "Arkansas" },
  { key: 7, value: "California" },
  { key: 8, value: "Colorado" },
  { key: 9, value: "Connecticut" },
  { key: 10, value: "DC" },
  { key: 11, value: "Delaware" },
  { key: 12, value: "Florida" },
  { key: 13, value: "Georgia" },
  { key: 14, value: "Guam" },
  { key: 15, value: "Hawaii" },
  { key: 16, value: "Idaho" },
  { key: 17, value: "Illinois" },
  { key: 18, value: "Indiana" },
  { key: 19, value: "Iowa" },
  { key: 20, value: "Kansas" },
  { key: 21, value: "Kentucky" },
  { key: 22, value: "Louisiana" },
  { key: 23, value: "Maine" },
  { key: 24, value: "Maryland" },
  { key: 25, value: "Massachusetts" },
  { key: 26, value: "Michigan" },
  { key: 27, value: "Minnesota" },
  { key: 28, value: "Mississippi" },
  { key: 29, value: "Missouri" },
  { key: 30, value: "Montana" },
  { key: 31, value: "Nebraska" },
  { key: 32, value: "Nevada" },
  { key: 33, value: "New Hampshire" },
  { key: 34, value: "New Jersey" },
  { key: 35, value: "New Mexico" },
  { key: 36, value: "New York" },
  { key: 37, value: "North Carolina" },
  { key: 38, value: "North Dakota" },
  { key: 39, value: "Ohio" },
  { key: 40, value: "Oklahoma" },
  { key: 41, value: "Oregon" },
  { key: 42, value: "Pennsylvania" },
  { key: 43, value: "Puerto Rico" },
  { key: 44, value: "Rhode Island" },
  { key: 45, value: "South Carolina" },
  { key: 46, value: "South Dakota" },
  { key: 47, value: "Tennessee" },
  { key: 48, value: "Texas" },
  { key: 49, value: "Utah" },
  { key: 50, value: "Vermont" },
  { key: 51, value: "Virgin Islands" },
  { key: 52, value: "Virginia" },
  { key: 53, value: "Washington" },
  { key: 54, value: "West Virginia" },
  { key: 55, value: "Wisconsin" },
  { key: 56, value: "Wyoming" },
  { key: 1248, value: "American Samoa" },
  { key: 1249, value: "Northern Mariana Islands" }
];

// FormData interface for the checkout form
interface FormData {
  firstName: string;
  lastName: string;
  email: string;
  phone: string;
  streetAddress: string;
  city: string;
  state: string;
  postalCode: string;
  country: string; // This will now hold the 2-letter country code
}

// Inner form component that has access to Stripe hooks
function CheckoutForm({ 
  selectedFrequency,
  isAmbassador,
  setIsAmbassador
}: { 
  selectedFrequency: string,
  isAmbassador: boolean,
  setIsAmbassador: React.Dispatch<React.SetStateAction<boolean>>
}) {
  const { items } = useCart();
  const { initiateCheckout, isLoading: checkoutLoading, error: checkoutError } = useCheckout();
  const stripe = useStripe();
  const elements = useElements();
  const pathname = usePathname();
  const router = useRouter();
  
  // Add loading and error states
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [cardElementReady, setCardElementReady] = useState(false);
  
  // Get stored referral code from localStorage
  const [storedPathParam, setStoredPathParam] = useState<string>('');
  const [storedAffiliateCode, setStoredAffiliateCode] = useState<string>('');
  
  // Add state for modal visibility
  const [showAmbassadorModal, setShowAmbassadorModal] = useState(false);
  
  // Add state for popups
  const [showTermsPopup, setShowTermsPopup] = useState(false);
  const [showMarketingPopup, setShowMarketingPopup] = useState(false);
  const [showPoliciesPopup, setShowPoliciesPopup] = useState(false);
  const [agreedToPolicies, setAgreedToPolicies] = useState(false);
  const [hasScrolledToBottom, setHasScrolledToBottom] = useState(false);
  
  useEffect(() => {
    // Get the stored path param from localStorage
    const pathParam = localStorage.getItem('pathParam');
    const affiliateCode = localStorage.getItem('affiliateCode');
    
    if (pathParam) {
      console.log('Retrieved stored path param:', pathParam);
      setStoredPathParam(pathParam);
    } else {
      console.log('No path param found in localStorage');
    }
    
    if (affiliateCode) {
      console.log('Retrieved stored affiliate code:', affiliateCode);
      setStoredAffiliateCode(affiliateCode);
    } else {
      console.log('No affiliate code found in localStorage');
    }
  }, []);

  // Add effect to check if Stripe is loaded
  useEffect(() => {
    if (!stripe || !elements) {
      console.log('Stripe.js has not yet loaded.');
      return;
    }
  }, [stripe, elements]);

  // Define getPriceInfo function
  const getPriceInfo = (frequency: string) => {
    if (frequency === 'monthly') {
      return {
        frequency: 'monthly',
        price: 47,
        discountPrice: 47,
        dailyPrice: (47 / 30).toFixed(2),
        savingsPercent: 0,
        totalPrice: 47,
        trialDays: 5
      };
    } else {
      // Calculate savings compared to monthly
      const annualCost = 397;
      const monthlyCostForYear = 47 * 12;
      const savings = monthlyCostForYear - annualCost;
      const savingsPercent = Math.round((savings / monthlyCostForYear) * 100);
      
      return {
        frequency: 'annual',
        price: monthlyCostForYear,
        discountPrice: annualCost,
        dailyPrice: (annualCost / 365).toFixed(2),
        savingsPercent: savingsPercent,
        totalPrice: annualCost,
        trialDays: 5
      };
    }
  };
  
  // Form state
  const [priceInfo, setPriceInfo] = useState(() => getPriceInfo(selectedFrequency));
  const [checkoutStep, setCheckoutStep] = useState(1);
  const [formData, setFormData] = useState<FormData>({
    firstName: '',
    lastName: '',
    email: '',
    phone: '',
    streetAddress: '',
    city: '',
    state: '',
    postalCode: '',
    country: 'US',
  });
  const [agreeToTerms, setAgreeToTerms] = useState(false);
  const [agreedToMarketing, setAgreedToMarketing] = useState(false);
  const [cardComplete, setCardComplete] = useState(false);
  const [formValid, setFormValid] = useState(false);
  const [step1Valid, setStep1Valid] = useState(false);
  const [currentFeatureIndex, setCurrentFeatureIndex] = useState(0);
  
  // Features data for carousel
  const features = [
    {
      title: "Relational routines",
      description: "Mini teachings and guided sessions to practice being with God"
    },
    {
      title: "Library of over 600 teachings",
      description: "Meditations, prayers and more from Graham Cooke"
    },
    {
      title: "Multi-day challenges",
      description: "Unpacking teaching series for deeper understanding"
    },
    {
      title: "Restful sleep content",
      description: "Prayers and music to help you rest in God's presence"
    }
  ];
  
  // Auto-rotate carousel
  useEffect(() => {
    const intervalId = setInterval(() => {
      setCurrentFeatureIndex((prevIndex) => 
        prevIndex === features.length - 1 ? 0 : prevIndex + 1
      );
    }, 4000); // Change slide every 4 seconds
    
    return () => clearInterval(intervalId);
  }, [features.length]);

  // Update priceInfo when selectedFrequency changes
  useEffect(() => {
    setPriceInfo(getPriceInfo(selectedFrequency));
  }, [selectedFrequency]);

  // Check if form step 1 is valid
  useEffect(() => {
    const isAddressValid = 
      formData.firstName.trim() !== '' && 
      formData.lastName.trim() !== '' && 
      formData.email.trim() !== '' &&
      formData.streetAddress.trim() !== '' &&
      formData.city.trim() !== '' &&
      formData.state.trim() !== '' &&
      formData.postalCode.trim() !== '' &&
      formData.country.trim() !== '';

    // Add US address validation for ambassadors
    if (isAmbassador) {
      if (formData.country !== 'US') {
        setError('Ambassador program is only available for US residents at this time.');
        setStep1Valid(false);
        return;
      }
      if (formData.phone.trim() === '') {
        setError('Phone number is required for ambassadors.');
        setStep1Valid(false);
        return;
      }
      // Basic US phone number validation
      const phoneRegex = /^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/;
      if (!phoneRegex.test(formData.phone)) {
        setError('Please enter a valid US phone number.');
        setStep1Valid(false);
        return;
      }
    }

    setError(null);
    setStep1Valid(isAddressValid);
  }, [formData, isAmbassador]);

  // Check if entire form is valid
  useEffect(() => {
    setFormValid(
      step1Valid &&
      agreeToTerms &&
      agreedToPolicies &&
      cardComplete
    );
  }, [step1Valid, agreeToTerms, agreedToPolicies, cardComplete]);

  // Save URL path parameter to localStorage
  useEffect(() => {
    if (pathname && pathname.length > 1) {
      // Remove the first slash and save the rest to localStorage
      const pathParam = pathname.substring(1);
      localStorage.setItem('pathParam', pathParam);
      console.log('Saved to localStorage:', pathParam);
    }
  }, [pathname]);

  // Automatically add a sample product to the cart if it's empty
  useEffect(() => {
    if (items.length === 0 && products.length > 0) {
      // Add a sample product to the cart
      const sampleProduct = products[0];
      // addToCart(sampleProduct);
    }
  }, [items.length]);

  // Add effect to update priceInfo when isAmbassador changes
  useEffect(() => {
    // Start with the base price info
    const baseInfo = getPriceInfo(selectedFrequency);
    
    // Update the price info based on ambassador status
    const updatedInfo = {
      ...baseInfo,
      // If ambassador is selected, add the ambassador program fee to display price
      totalPrice: isAmbassador ? baseInfo.totalPrice + 10 : baseInfo.totalPrice,
      // Set trialDays to 0 if ambassador, otherwise keep 5-day trial
      trialDays: isAmbassador ? 0 : 5,
    };
    
    // Store the ambassador status in localStorage
    localStorage.setItem('isAmbassador', isAmbassador.toString());
    
    setPriceInfo(updatedInfo);
  }, [isAmbassador, selectedFrequency]);

  // Add this useEffect to check localStorage for policy acceptance
  useEffect(() => {
    // Check if localStorage has the policy agreement flag
    if (typeof window !== 'undefined') {
      const hasPolicyAgreement = localStorage.getItem('agreedToPolicies') === 'true';
      
      if (hasPolicyAgreement) {
        setAgreedToPolicies(true);
      }
    }
  }, []);

  // Reset hasScrolledToBottom when popup closes
  useEffect(() => {
    if (!showPoliciesPopup) {
      setHasScrolledToBottom(false);
    }
  }, [showPoliciesPopup]);

  // Track iframe scrolling
  const policyContentRef = useRef<HTMLDivElement>(null);
  
  // Function to check if user has scrolled to bottom of content
  const checkScrollPosition = () => {
    const element = policyContentRef.current;
    if (element) {
      const { scrollTop, scrollHeight, clientHeight } = element;
      // Allow a 30px margin for "bottom"
      const isAtBottom = scrollHeight - scrollTop - clientHeight < 30;
      if (isAtBottom) {
        setHasScrolledToBottom(true);
      }
    }
  };

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
    const { name, value } = e.target;
    setFormData(prevData => ({
      ...prevData,
      [name]: value
    }));
  };

  const handleCardChange = (event: StripeCardElementChangeEvent) => {
    setCardComplete(event.complete);
    setCardElementReady(true);
    if (event.error) {
      setError(event.error.message || 'An error occurred with the card element');
    } else {
      setError(null);
    }
  };

  // Handle form submission
  const handleSubmit = async (event: React.FormEvent) => {
    event.preventDefault();
    
    if (isLoading) {
      console.log('Submission already in progress');
      return;
    }

    setIsLoading(true);
    setError('');

    try {
      if (checkoutStep === 1) {
        setCheckoutStep(2);
        localStorage.setItem('isAmbassador', isAmbassador.toString());
        localStorage.setItem('selectedFrequency', selectedFrequency);
        setIsLoading(false);
        return;
      }

      // Create payment method
      const { error: stripeError, paymentMethod } = await stripe!.createPaymentMethod({
        type: 'card',
        card: elements!.getElement(CardElement)!,
        billing_details: {
          name: `${formData.firstName} ${formData.lastName}`,
          email: formData.email,
          address: {
            line1: formData.streetAddress,
            city: formData.city,
            state: formData.state,
            postal_code: formData.postalCode,
            country: formData.country,
          },
        },
      });

      if (stripeError) {
        console.error('Error creating payment method:', stripeError);
        setError(stripeError.message || 'Failed to process payment method');
        setIsLoading(false);
        return;
      }

      // Get affiliate code from localStorage or path parameter
      const affiliateCode = localStorage.getItem('affiliateCode') || storedPathParam;

      // Process checkout
      const response = await fetch('/api/direct-checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          customerInfo: formData,
          paymentMethodId: paymentMethod.id,
          frequency: selectedFrequency,
          pathParam: affiliateCode,
          isAmbassador,
          ambassadorPriceId: process.env.NEXT_PUBLIC_STRIPE_AMBASSADOR_FEE_PRICE_ID,
          marketingConsent: agreedToMarketing ? 'yes' : 'no',
          termsConsent: agreeToTerms ? 'yes' : 'no'
        }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to process checkout');
      }

      // Handle main subscription payment confirmation
      if (data.mainPaymentIntentSecret) {
        const { error: confirmError } = await stripe!.confirmCardPayment(data.mainPaymentIntentSecret);
        if (confirmError) {
          throw new Error(`Failed to confirm main subscription payment: ${confirmError.message}`);
        }
        
        // Add a small delay before processing the ambassador fee
        if (isAmbassador && data.ambassadorPaymentIntentSecret) {
          await new Promise(resolve => setTimeout(resolve, 1000)); // 1 second delay
        }
      }

      // Handle ambassador fee payment confirmation if applicable
      if (isAmbassador && data.ambassadorPaymentIntentSecret) {
        try {
          const { error: ambassadorConfirmError } = await stripe!.confirmCardPayment(data.ambassadorPaymentIntentSecret);
          if (ambassadorConfirmError) {
            console.error('Ambassador fee confirmation error:', ambassadorConfirmError);
            // Don't throw error, just log it and continue
            // The main subscription is already confirmed
          }
        } catch (retryError) {
          console.error('Retrying ambassador fee confirmation...');
          // Wait 2 seconds and try one more time
          await new Promise(resolve => setTimeout(resolve, 2000));
          const { error: retryConfirmError } = await stripe!.confirmCardPayment(data.ambassadorPaymentIntentSecret);
          if (retryConfirmError) {
            console.error('Final ambassador fee confirmation error:', retryConfirmError);
            // Still don't throw, just log the error
          }
        }
      }

      // Redirect to success page
      router.push(`/ambassador-details?subscriptionId=${data.subscriptionId}`);
    } catch (error: any) {
      console.error('Checkout error:', error);
      setError(error.message || 'An unexpected error occurred');
      setIsLoading(false);
    }
  };

  const handleBack = () => {
    if (checkoutStep > 1) {
      setCheckoutStep(checkoutStep - 1);
    }
  };

  const handlePlaceSelected = (place: any) => {
    if (!place || !place.address_components) return;
    
    const address = parseAddressComponents(place);
    
    // Find country code for the selected country name
    let countryCode = 'US'; // Default to US
    const countryOption = COUNTRY_OPTIONS.find(c => 
      c.name.toLowerCase() === address.country.toLowerCase()
    );
    
    if (countryOption) {
      countryCode = countryOption.code;
    }
    
    // Update form data with the parsed address
    setFormData(prevData => ({
      ...prevData,
      streetAddress: address.streetAddress,
      city: address.city,
      state: address.state,
      postalCode: address.postalCode,
      country: countryCode // Use the country code instead of name
    }));
  };
  
  // Initialize the Google Places autocomplete
  useGooglePlacesAutocomplete({
    inputId: 'streetAddress',
    onPlaceSelected: handlePlaceSelected
  });

  // Render progress steps
  const renderSteps = () => {
    return (
      <div className="mb-8">
        <div className="flex items-center">
          <div className={`flex items-center justify-center w-8 h-8 rounded-full ${checkoutStep >= 1 ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'}`}>
            1
          </div>
          <div className={`flex-1 h-0.5 mx-2 ${checkoutStep >= 2 ? 'bg-blue-600' : 'bg-gray-200'}`}></div>
          <div className={`flex items-center justify-center w-8 h-8 rounded-full ${checkoutStep >= 2 ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'}`}>
            2
          </div>
        </div>
        <div className="flex justify-between mt-1 text-xs">
          <span className={checkoutStep >= 1 ? 'text-blue-600 font-medium' : 'text-gray-500'}>Your Information</span>
          <span className={checkoutStep >= 2 ? 'text-blue-600 font-medium' : 'text-gray-500'}>Payment</span>
        </div>
      </div>
    );
  };

  // Render step 1 form (customer information)
  const renderStep1 = () => {
    return (
      <div className="space-y-3 md:space-y-4">
        <div className="grid grid-cols-2 gap-x-3 gap-y-3">
          <div>
            <label htmlFor="firstName" className="block text-xs md:text-sm font-medium text-gray-700 mb-1">
              First Name
            </label>
            <input
              type="text"
              id="firstName"
              name="firstName"
              value={formData.firstName}
              onChange={handleInputChange}
              required
              className="w-full px-3 py-2 h-9 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <div>
            <label htmlFor="lastName" className="block text-xs md:text-sm font-medium text-gray-700 mb-1">
              Last Name
            </label>
            <input
              type="text"
              id="lastName"
              name="lastName"
              value={formData.lastName}
              onChange={handleInputChange}
              required
              className="w-full px-3 py-2 h-9 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
        </div>

        <div>
          <label htmlFor="email" className="block text-xs md:text-sm font-medium text-gray-700 mb-1">
            Email
          </label>
          <input
            type="email"
            id="email"
            name="email"
            value={formData.email}
            onChange={handleInputChange}
            required
            className="w-full px-3 py-2 h-9 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500"
          />
        </div>

        {isAmbassador && (
          <div>
            <label htmlFor="phone" className="block text-xs md:text-sm font-medium text-gray-700 mb-1">
              Phone Number <span className="text-xs text-gray-500">(Required for ambassadors)</span>
            </label>
            <input
              type="tel"
              id="phone"
              name="phone"
              value={formData.phone}
              onChange={handleInputChange}
              placeholder="(123) 456-7890"
              required={isAmbassador}
              className="w-full px-3 py-2 h-9 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
        )}

        <div>
          <label htmlFor="streetAddress" className="block text-xs md:text-sm font-medium text-gray-700 mb-1">
            Billing Address
          </label>
          <input
            type="text"
            id="streetAddress"
            name="streetAddress"
            value={formData.streetAddress}
            onChange={handleInputChange}
            required
            autoComplete="off"
            className="w-full px-3 py-2 h-9 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500"
          />
        </div>

        <div className="grid grid-cols-2 gap-x-3 gap-y-3">
          <div>
            <label htmlFor="city" className="block text-xs md:text-sm font-medium text-gray-700 mb-1">
              City
            </label>
            <input
              type="text"
              id="city"
              name="city"
              value={formData.city}
              onChange={handleInputChange}
              required
              className="w-full px-3 py-2 h-9 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <div>
            <label htmlFor="state" className="block text-xs md:text-sm font-medium text-gray-700 mb-1">
              State/Province
            </label>
            {formData.country === 'US' ? (
              <select
                id="state"
                name="state"
                value={formData.state}
                onChange={handleInputChange}
                required
                className="w-full px-3 py-2 h-9 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500"
              >
                <option value="">Select a state</option>
                {US_STATE_OPTIONS.map(state => (
                  <option key={state.key} value={state.value}>
                    {state.value}
                  </option>
                ))}
              </select>
            ) : (
              <input
                type="text"
                id="state"
                name="state"
                value={formData.state}
                onChange={handleInputChange}
                required
                className="w-full px-3 py-2 h-9 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500"
              />
            )}
          </div>
        </div>

        <div className="grid grid-cols-2 gap-x-3 gap-y-3">
          <div>
            <label htmlFor="postalCode" className="block text-xs md:text-sm font-medium text-gray-700 mb-1">
              Postal Code
            </label>
            <input
              type="text"
              id="postalCode"
              name="postalCode"
              value={formData.postalCode}
              onChange={handleInputChange}
              required
              className="w-full px-3 py-2 h-9 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <div>
            <label htmlFor="country" className="block text-xs md:text-sm font-medium text-gray-700 mb-1">
              Country
            </label>
            <select
              id="country"
              name="country"
              value={formData.country}
              onChange={handleInputChange}
              required
              className="w-full px-3 py-2 h-9 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500"
            >
              <option value="">Select a country</option>
              {COUNTRY_OPTIONS.map(country => (
                <option key={country.code} value={country.code}>
                  {country.name}
                </option>
              ))}
            </select>
          </div>
        </div>

        {/* Ambassador Add-on */}
        <div className="bg-[#F8F9FF] rounded-2xl p-6">
          <h2 className="text-[#1E40AF] text-xl font-semibold mb-4">Brilliant Ambassador Program</h2>
          <div className="flex items-center justify-between">
            <div>
              <h3 className="text-lg font-medium text-gray-900">Become an Ambassador</h3>
              <p className="text-gray-600">Earn commissions and get exclusive benefits</p>
            </div>
            <div className="flex items-center gap-4">
              <a href="/ambassador" className="text-[#2A9D8F] hover:text-[#238276] font-medium">
                Learn More
              </a>
              <Switch
                checked={isAmbassador}
                onChange={setIsAmbassador}
                className={`${
                  isAmbassador ? 'bg-[#2A9D8F]' : 'bg-gray-200'
                } relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-[#2A9D8F] focus:ring-offset-2`}
              >
                <span className="sr-only">Enable ambassador program</span>
                <span
                  className={`${
                    isAmbassador ? 'translate-x-6' : 'translate-x-1'
                  } inline-block h-4 w-4 transform rounded-full bg-white transition-transform`}
                />
              </Switch>
            </div>
          </div>
          <div className="mt-4">
            <a href="https://go.brilliantplus.app/" className="text-[#2A9D8F] hover:text-[#238276] text-sm">
              Just want to be an ambassador? Click here â†’
            </a>
          </div>
        </div>
      </div>
    );
  };

  // Render step 2 form (payment)
  const renderStep2 = () => {
    return (
      <div className="space-y-4">
        <h3 className="text-lg font-semibold mb-4">Payment Information</h3>
        
        <div className="mb-4">
          <label htmlFor="card-element" className="block text-sm font-medium text-gray-700 mb-1">
            Credit or debit card
          </label>
          <div className="p-3 border border-gray-300 rounded-md bg-white">
            <CardElement 
              id="card-element"
              options={{
                style: {
                  base: {
                    fontSize: '16px',
                    color: '#424770',
                    '::placeholder': {
                      color: '#aab7c4',
                    },
                  },
                  invalid: {
                    color: '#9e2146',
                  },
                },
              }}
              onChange={handleCardChange}
            />
            {checkoutStep === 2 && !cardElementReady && (
              <p className="mt-1 text-xs text-gray-500">
                Please enter your card details
              </p>
            )}
          </div>
        </div>
        
        <div className="flex items-start mb-4">
          <div className="flex items-center h-5">
            <input
              id="terms"
              name="terms"
              type="checkbox"
              checked={agreeToTerms}
              onChange={(e) => {
                if (e.target.checked) {
                  setShowTermsPopup(true);
                } else {
                  setAgreeToTerms(false);
                }
              }}
              className="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
            />
          </div>
          <div className="ml-3 text-sm">
            <label htmlFor="terms" className="font-medium text-gray-700">
              I agree to the <button 
                type="button" 
                onClick={() => setShowTermsPopup(true)} 
                className="text-blue-600 hover:text-blue-800 underline"
              >
                Ambassador Agreement
              </button>
            </label>
          </div>
        </div>

        <div className="flex items-start mb-4">
          <div className="flex items-center h-5">
            <input
              id="marketing"
              name="marketing"
              type="checkbox"
              checked={agreedToMarketing}
              onChange={(e) => {
                setAgreedToMarketing(e.target.checked);
                if (e.target.checked) {
                  setHasScrolledToBottom(false); // Reset scroll state
                  setShowPoliciesPopup(true);
                }
              }}
              className="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
            />
          </div>
          <div className="ml-3 text-sm">
            <label htmlFor="marketing" className="font-medium text-gray-700">
              I have read and agree to the <button 
                type="button" 
                onClick={() => setShowPoliciesPopup(true)} 
                className="text-blue-600 hover:text-blue-800 underline"
              >
                Policies & Procedures
              </button> for Brilliant Ambassadors
            </label>
          </div>
        </div>
      </div>
    );
  };

  const renderPoliciesCheckbox = () => {
    return (
      <div className="flex items-start mb-4">
        <div className="flex items-center h-5">
          <input
            id="policies"
            name="policies"
            type="checkbox"
            checked={agreedToPolicies}
            onChange={(e) => {
              setAgreedToPolicies(e.target.checked);
              if (e.target.checked) {
                setHasScrolledToBottom(false); // Reset scroll state
                setShowPoliciesPopup(true);
              }
            }}
            className="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
          />
        </div>
        <div className="ml-3 text-sm">
          <label htmlFor="policies" className="font-medium text-gray-700">
            I have read and agree to the <button 
              type="button"
              onClick={() => {
                setHasScrolledToBottom(false); // Reset scroll state
                setShowPoliciesPopup(true);
              }}
              className="text-blue-600 hover:text-blue-800 underline"
            >
              Policies & Procedures
            </button> for Brilliant Ambassadors
          </label>
        </div>
      </div>
    );
  };

  const renderMarketingCheckbox = () => {
    if (!isAmbassador) return null;
    
    return (
      <div className="mt-4">
        <div className="flex items-start">
          <div className="flex items-center h-5">
            <input
              id="marketing"
              name="marketing"
              type="checkbox"
              checked={agreedToMarketing}
              onChange={(e) => {
                setAgreedToMarketing(e.target.checked);
                if (e.target.checked) {
                  setHasScrolledToBottom(false); // Reset scroll state
                  setShowPoliciesPopup(true);
                }
              }}
              className="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
            />
          </div>
          <div className="ml-3 text-sm">
            <label htmlFor="marketing" className="font-medium text-gray-700">
              I have read and agree to the <button 
                type="button"
                onClick={() => {
                  setHasScrolledToBottom(false); // Reset scroll state
                  setShowPoliciesPopup(true);
                }}
                className="text-blue-600 hover:text-blue-800 underline"
              >
                Policies & Procedures
              </button> for Brilliant Ambassadors
            </label>
          </div>
        </div>
      </div>
    );
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4 md:space-y-5">
      {/* Checkout Steps Progress Indicator */}
      {renderSteps()}
      
      <div className="max-h-[45vh] md:max-h-[55vh] overflow-y-auto pr-1 pb-2">
        {checkoutStep === 1 && renderStep1()}
        {checkoutStep === 2 && renderStep2()}
      </div>

      <div className="flex items-center justify-between space-x-3 md:space-x-4 mt-4">
        {checkoutStep > 1 && (
          <button
            type="button"
            onClick={handleBack}
            className="flex-1 py-2 md:py-3 px-3 md:px-4 border border-gray-300 rounded-md shadow-sm text-sm md:text-base font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          >
            Back
          </button>
        )}
        <button
          type="submit"
          disabled={checkoutStep === 1 ? !step1Valid : (isLoading || !formValid || !agreeToTerms || !agreedToPolicies)}
          className={`flex-1 py-2 md:py-3 px-3 md:px-4 rounded-md shadow-sm text-sm md:text-base font-medium text-white ${
            (checkoutStep === 1 ? !step1Valid : (isLoading || !formValid || !agreeToTerms || !agreedToPolicies))
              ? "bg-gray-400 cursor-not-allowed"
              : "bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          }`}
        >
          {isLoading ? (
            <span className="flex items-center justify-center">
              <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Processing...
            </span>
          ) : checkoutStep === 1 ? (
            "Continue to Payment"
          ) : (
            isAmbassador ? "Pay Now" : "Start Your Free Trial"
          )}
        </button>
      </div>
      <div className="flex justify-center space-x-4 mt-2">
        <div className="flex items-center">
          <svg className="h-4 w-4 text-gray-400 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
          </svg>
          <span className="text-xs text-gray-500">Secure</span>
        </div>
        <div className="flex items-center">
          <svg className="h-4 w-4 text-gray-400 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          <span className="text-xs text-gray-500">Cancel Anytime</span>
        </div>
      </div>

      {/* Terms & Conditions Popup */}
      {showTermsPopup && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-xl font-semibold">Ambassador Agreement</h3>
              <button 
                type="button" 
                onClick={() => setShowTermsPopup(false)}
                className="text-gray-500 hover:text-gray-700"
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            <div className="mb-6 text-sm text-gray-700">
              <h2 className="text-center font-bold mb-4">BRILLIANT PERSPECTIVES AFFILIATE<br/>APPLICATION & AGREEMENT</h2>

              <p className="mb-3">1. <strong>Authorization and Contract.</strong> By signing this Brilliant Perspectives Ambassador Agreement ("Agreement"), you are applying for legal authorization to become a Brilliant Perspectives Ambassador as an independent business owner and enter into contract with Brilliant Perspectives, LLC ( "Company"). You acknowledge that prior to signing this Agreement you have received, read and understood the Company Income Disclosure Statement, the Company Policies and Procedures, the Compensation Plan, (collectively, the "Ambassador Documents") and all terms set forth in this Agreement. The Ambassador Documents are incorporated herein by reference. Company reserves the right to reject any application for any reason within thirty (30) days of receipt. Please note that this Ambassador Agreement is a broadly drafted document, the specifics of which are further detailed within the Company Policies and Procedures. If any provisions herein conflict with the Policies and Procedures, the Policies and Procedures shall govern.</p>

              <p className="mb-3">2. <strong>Term.</strong> This Agreement will remain in effect until you voluntarily cancel the Agreement, your account becomes inactive and/or you fail to renew, or the Company terminates you as an Ambassador, as outlined in the Ambassador Documents. In the event of cancellation, termination or nonrenewal, you waive all rights you have, including but not limited to eligibility to sell Company products or services, property rights to your former downline organization, and any commissions, bonuses, or other remuneration derived through the sales and other activities of your former downline organization. Company reserves the right to terminate all Ambassador Agreements upon thirty (30) days' notice if the Company elects to: (1) cease business operations; (2) dissolve as a business entity; or (3) terminate distribution of its products and/or services via direct selling channels. An Ambassador may cancel this Agreement at any time, and for any reason, upon written notice to Company. Company may cancel this Agreement at any time and for any reason upon written notice to the Ambassador. Company may also take actions short of termination of the Agreement if the Ambassador breaches any of its obligations under the Agreement.</p>

              <p className="mb-3">3. <strong>Independent Contractor Status.</strong> You agree this authorization does not make you an employee, agent, or legal representative of Company or your sponsoring Ambassador. As a self-employed independent contractor, you will be operating your own independent business. You have complete freedom in determining the number of hours that you will devote to your business and you have the sole discretion of scheduling such hours. In accordance with the Company Policies and Procedures, you will receive IRS Form 1099-NEC reflecting the amount of income paid to you during the calendar year. By agreeing to these terms, you agree to receive the 1099-NEC form electronically. It will be your sole responsibility to account for such income on your individual income tax returns.</p>

              <p className="mb-3">4. <strong>Presenting the Opportunity.</strong> You agree when representing the Company opportunity to represent it in its entirety as outlined in Official Company Materials. In presenting the opportunity, you agree not to utilize any literature, materials or aids not produced or specifically authorized in writing by the Company. You also agree to present the Company Income Disclosure Statement to all prospective Ambassadors and to instruct them to review it prior to enrollment.</p>

              <p className="mb-3">5. <strong>Refunds.</strong> Ambassadors are never required to purchase product. Any product purchase is meant for that Ambassador's personal consumption and all consumer refund policies shall apply as outlined for the particular product or service on the Company corporate website and as displayed at the point of sale. Commissions derived from any refund shall be dealt with as detailed within the Company Policies and Procedures.</p>

              <p className="mb-3">6. <strong>Proprietary Information and Trade Secrets.</strong> You recognize and agree that, as further set forth in the Company Policies and Procedures, information compiled by or maintained by Company, including Line of Sponsorship (LOS) information (i.e., information that discloses or relates to all or part of the specific arrangement of sponsorship within the Company business including, without limitation, distributor lists, sponsorship trees, and all Company partner information generated therefrom, in its present or future forms), constitutes a commercially advantageous, unique and proprietary trade secret of Company, which it keeps as proprietary and confidential. During the term of this Agreement, Company grants you a personal, non-exclusive, non-transferable and revocable right to use trade secret, confidential, and proprietary business information (collectively, "Proprietary Information"), which includes, without limitation, LOS information, business reports, manufacturing and product developments, partner sales, and earnings and other financial reports to facilitate your Company business.</p>

              <p className="mb-3">7. <strong>Non-Solicitation and Other Business Restrictions.</strong> Ambassadors may participate in other direct sales, multilevel, network marketing or relationship marketing business ventures or marketing opportunities (collectively, "Network Marketing") provided that: (i) the other Network Marketing company does not market and sell competing products or services to those of Company, as determined by the Company in its sole discretion; and (ii) the Ambassador maintains the ability to fully perform all obligations under this Agreement. However, during the Term of this Agreement and for one (1) year thereafter, an Ambassador may not recruit any Ambassador or Customer for any other Network Marketing business, unless that Ambassador or Customer was personally sponsored by such Ambassador. This provision is more fully detailed within the Company Policies and Procedures.</p>

              <p className="mb-3">8. <strong>Images / Recordings / Consents.</strong> You agree to permit Company to obtain photographs, videos, and other recorded media of you or your likeness. You acknowledge and agree to allow any such recorded media to be used by Company for any lawful purpose and without compensation.</p>

              <p className="mb-3">9. <strong>Modification of Terms.</strong> With the exception of the Dispute Resolution Section in the Company Policies and Procedures and as briefly outlined herein, which can only be modified by way of mutual consent, the Company may modify the terms of this Agreement upon written notice as detailed within the Company Policies and Procedures.</p>

              <p className="mb-3">10. <strong>Governing Law.</strong> The formation, construction, interpretation, and enforceability of your contract with Company as set forth in this Ambassador Agreement shall be governed by the laws of the State of California, United States of America, without giving effect to any choice of law rule that would cause the application of laws of any jurisdiction other than the laws of the State of California, except that the Federal Arbitration Act shall govern the Dispute Resolution provision of this Agreement, without giving effect to any state law to the contrary.</p>

              <p className="mb-3">Louisiana residents: Notwithstanding the foregoing, venue and jurisdiction for any claims or disputes arising under or relating to this Ambassador Agreement brought by residents of Louisiana shall be established pursuant to Louisiana law.</p>

              <p className="mb-3">11. <strong>Dispute Resolution.</strong> PLEASE READ CAREFULLY THE DISPUTE RESOLUTION PROVISION IN THIS SECTION AND AS FURTHER DETAILED IN THE POLICIES AND PROCEDURES (COLLECTIVELY THE "DISPUTE RESOLUTION AGREEMENT") AS IT AFFECTS HOW CLAIMS YOU MAY HAVE AGAINST THE COMPANY, OR CLAIMS THE COMPANY MAY HAVE AGAINST YOU, WILL BE RESOLVED. BY SIGNING AND SUBMITTING THIS APPLICATION, YOU AGREE TO BE BOUND BY THIS DISPUTE RESOLUTION AGREEMENT.</p>

              <p className="mb-3">LINK TO DISPUTE RESOLUTION HERE.</p>

              <p className="mb-3">12. <strong>Time Limitation.</strong> If an Ambassador wishes to bring an action against Company for any act or omission relating to or arising from this Agreement, such action must be brought within one (1) year from the date of the alleged conduct first giving rise to the cause of action. The Ambassador waives all claims that any other statutes of limitations apply.</p>

              <p className="mb-3">13. <strong>Indemnification.</strong> An Ambassador is fully responsible for all of their verbal and written communications made regarding Company products, services, and the Compensation Plan that are not expressly contained within Official Company materials. Ambassadors shall indemnify and hold harmless Company, its directors, officers, employees, and agents from and against any and all liability, judgments, refunds, damages, fines, penalties, and costs (including reasonable attorney's fees and court costs) arising from or relating to the Ambassador's: (i) unauthorized representations or actions; (ii) breach of the Ambassador Documents; or (iii) violation of or failure to comply with any applicable federal, state or local law or regulation. This provision shall survive the termination of the Ambassador Agreement.</p>

              <p className="mb-3">14. <strong>Miscellaneous.</strong> The provisions of this Agreement, including all documents incorporated herein by reference, embody the whole agreement between you and Company and supersede any prior agreements, understandings and obligations between you and Company concerning the subject matter of your contract with Company. If any term herein is to be found in conflict with the Company Policies and Procedures, the Policies and Procedures shall govern.</p>

              <p className="mb-3">15. <strong>Notice of Right to Cancel.</strong> You may CANCEL this application, without any penalty or obligation, within THREE (3) BUSINESS DAYS from the application date (FIVE (5) BUSINESS days for Alaska residents, FIFTEEN (15) DAYS for Montana residents and FIFTEEN (15) BUSINESS days for North Dakota residents aged 65 or older). Maryland residents may cancel this Agreement through written notice to the Company for any reason within three (3) months after the date of receipt of goods or services first ordered. Puerto Rico residents may cancel this Agreement for any reason within ninety (90) days of enrollment.</p>

              <p className="mb-3">If you cancel, any payments made by you at the time you submitted this Application will be returned within TEN (10) BUSINESS DAYS following Company's receipt of your cancellation notice.</p>

              <p className="mb-3">16. <strong>Submission of Electronic W-9.</strong> Under penalty of perjury, I certify that (1) the number shown on this form is my correct taxpayer identification number (or I am waiting for a number to be issued to me), and (2), I am not subject to backup withholding because: (a) I am exempt from backup withholding, or (b) I have not been notified by the Internal Revenue Service (IRS) that I am subject to backup withholding as a result of a failure to report all interest or dividends, or (c) the IRS has notified me that I am no longer subject to backup withholding, and (3) I am a U.S. Citizen or other U.S. person.</p>

              <p className="mb-3">17. <strong>Severability.</strong> If any provision of this Agreement is found by a court of competent jurisdiction, an arbitrator, or an arbitral panel to be invalid, illegal, or unenforceable in any respect, such provision shall be modified and interpreted to the extent necessary to render it valid, legal, and enforceable while preserving its original intent. The invalidity, illegality, or unenforceability of any provision shall not affect the validity, legality, or enforceability of any other provision of this Agreement.</p>

              <p className="mb-3">If any part of this Agreement is held to be invalid or unenforceable in any jurisdiction where this Agreement is being performed, the remainder of this Agreement shall continue to be valid and enforceable. In such a situation, the court, arbitrator, or arbitral panel shall have the authority to modify the provision to the extent necessary to make it enforceable under the circumstances.</p>

              <p className="mb-3">The Parties agree to negotiate in good faith to replace any invalid, illegal, or unenforceable provision with a valid, legal, and enforceable provision that most closely approximates the original intent and economic effect of the invalid, illegal, or unenforceable provision. If the Parties cannot reach agreement on a replacement provision within thirty (30) days, either Party may request that the court, arbitrator, or arbitral panel fashion an appropriate replacement provision that preserves the economic benefits intended by the Parties.</p>
            </div>
            <div className="flex justify-end space-x-4">
              <button
                type="button"
                onClick={() => {
                  setAgreeToTerms(false);
                  setShowTermsPopup(false);
                }}
                className="border border-gray-300 bg-white text-gray-700 px-4 py-2 rounded hover:bg-gray-50"
              >
                Decline
              </button>
              <button
                type="button"
                onClick={() => {
                  setAgreeToTerms(true);
                  setShowTermsPopup(false);
                }}
                className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
              >
                Accept
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Marketing Popup */}
      {showMarketingPopup && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-xl font-semibold">Policies & Procedures</h3>
              <button 
                type="button" 
                onClick={() => setShowMarketingPopup(false)}
                className="text-gray-500 hover:text-gray-700"
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            <div className="mb-6 text-sm text-gray-700">
              <h2 className="text-center font-bold mb-4">BRILLIANT PERSPECTIVES<br/>POLICIES & PROCEDURES</h2>
              
              <p className="mb-4">The Policies & Procedures document provides detailed guidelines for Brilliant Perspectives Ambassadors. This document outlines the rules, requirements, and expectations for all ambassadors representing the company.</p>
              
              <p className="mb-4">By accepting these Policies & Procedures, you agree to follow all company guidelines regarding:</p>
              
              <ul className="list-disc pl-6 mb-4">
                <li className="mb-2">Ethical marketing practices</li>
                <li className="mb-2">Proper representation of company products and services</li>
                <li className="mb-2">Compliance with all applicable laws and regulations</li>
                <li className="mb-2">Commission structure and payment processes</li>
                <li className="mb-2">Social media and promotional guidelines</li>
                <li className="mb-2">Customer service standards</li>
              </ul>
              
              <p className="mb-4">This is a placeholder for the full Policies & Procedures document. The complete document will be provided to you upon acceptance.</p>
            </div>
            <div className="flex justify-end space-x-4">
              <button
                type="button"
                onClick={() => {
                  setAgreedToMarketing(false);
                  setShowMarketingPopup(false);
                }}
                className="border border-gray-300 bg-white text-gray-700 px-4 py-2 rounded hover:bg-gray-50"
              >
                Decline
              </button>
              <button
                type="button"
                onClick={() => {
                  setAgreedToMarketing(true);
                  setShowMarketingPopup(false);
                }}
                className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
              >
                Accept
              </button>
            </div>
          </div>
        </div>
      )}

      {showPoliciesPopup && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg p-6 max-w-2xl w-full flex flex-col" style={{ maxHeight: "90vh" }}>
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-xl font-semibold">Policies & Procedures</h3>
              <button 
                type="button" 
                onClick={() => setShowPoliciesPopup(false)}
                className="text-gray-500 hover:text-gray-700"
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            <div 
              className="flex-grow overflow-auto"
              style={{ 
                scrollbarWidth: 'thin',
                scrollbarColor: '#4f46e5 #f3f4f6'
              }}
            >
              <PoliciesWithButtons
                onAccept={() => {
                  setAgreedToPolicies(true);
                  setShowPoliciesPopup(false);
                }}
                onDecline={() => {
                  setAgreedToPolicies(false);
                  setShowPoliciesPopup(false);
                }}
              />
            </div>
          </div>
        </div>
      )}
    </form>
  );
}

// Main component - wraps the checkout form with Stripe Elements
export default function Home() {
  const { items, totalPrice, clearCart, addToCart } = useCart();
  const pathname = usePathname();
  
  // Define getPriceInfo function before using it in useState
  const getPriceInfo = (frequency: string) => {
    if (frequency === 'monthly') {
      return {
        frequency: 'monthly',
        price: 47,
        discountPrice: 47,
        dailyPrice: (47 / 30).toFixed(2),
        savingsPercent: 0,
        totalPrice: 47,
        trialDays: 5
      };
    } else {
      // Calculate savings compared to monthly
      const annualCost = 397;
      const monthlyCostForYear = 47 * 12;
      const savings = monthlyCostForYear - annualCost;
      const savingsPercent = Math.round((savings / monthlyCostForYear) * 100);
      
      return {
        frequency: 'annual',
        price: monthlyCostForYear,
        discountPrice: annualCost,
        dailyPrice: (annualCost / 365).toFixed(2),
        savingsPercent: savingsPercent,
        totalPrice: annualCost,
        trialDays: 5
      };
    }
  };
  
  const [selectedFrequency, setSelectedFrequency] = useState('annual');
  const [priceInfo, setPriceInfo] = useState(() => getPriceInfo('annual'));
  const [referralCode, setReferralCode] = useState<string>('');
  const [isAmbassador, setIsAmbassador] = useState(false);
  
  // Check if the user came from the ambassador page and set isAmbassador accordingly
  useEffect(() => {
    // Check if the previous page was the ambassador page
    const referrer = document.referrer;
    const fromAmbassadorPage = referrer.includes('/ambassador') || 
                               localStorage.getItem('fromAmbassadorPage') === 'true';
    
    // If coming from ambassador page, automatically set the ambassador toggle to true
    if (fromAmbassadorPage) {
      setIsAmbassador(true);
      // Clear the flag after using it
      localStorage.removeItem('fromAmbassadorPage');
    }
  }, []);

  // Update priceInfo when selectedFrequency or isAmbassador changes
  useEffect(() => {
    const baseInfo = getPriceInfo(selectedFrequency);
    setPriceInfo({
      ...baseInfo,
      totalPrice: isAmbassador ? baseInfo.totalPrice + 10 : baseInfo.totalPrice,
    });
  }, [selectedFrequency, isAmbassador]);

  // Set referral code from URL path parameter
  useEffect(() => {
    if (pathname && pathname.length > 1) {
      // Remove the first slash and get the path parameter
      const pathParam = pathname.substring(1);
      setReferralCode(pathParam);
    }
  }, [pathname]);

  // Automatically add a sample product to the cart if it's empty
  useEffect(() => {
    if (items.length === 0 && products.length > 0) {
      // Add a sample product to the cart
      const sampleProduct = products[0];
      addToCart(sampleProduct);
    }
  }, [items.length, addToCart]);
  
  return (
    <div className="h-screen flex flex-col md:flex-row overflow-hidden">
      {/* Left Section (Checkout) */}
      <div className="flex-1 md:w-3/5 bg-white p-4 md:p-8 lg:p-12 overflow-auto">
        <div className="max-w-lg mx-auto">
          {/* Logo */}
          <div className="mb-6 md:mb-8">
            <Image
              src="/Blacklogo.png" 
              alt="Brilliant Logo" 
              width={180}
              height={60} 
              className="h-auto w-auto"
            />
          </div>
          
          {/* Headline */}
          <div className="mb-6 md:mb-8">
            {/* Removed headline and subtext as requested */}
          </div>
          
          {/* Pricing Section */}
          <div className="mb-6 md:mb-8">
            <div className="grid grid-cols-2 gap-3 md:gap-4">
              {/* Monthly Option */}
              <div
                className={`border ${
                  selectedFrequency === 'monthly' ? 'border-blue-500 border-2' : 'border-gray-300'
                } rounded-lg p-3 md:p-4 cursor-pointer hover:border-blue-400 transition-colors`}
                onClick={() => setSelectedFrequency('monthly')}
              >
                <div className="flex justify-between items-start mb-2">
                  <div>
                    <h3 className="font-medium text-gray-900">Monthly</h3>
                    <p className="text-sm text-gray-500">Auto-renews monthly</p>
                  </div>
                  <input
                    type="radio"
                    name="plan"
                    checked={selectedFrequency === 'monthly'}
                    onChange={() => setSelectedFrequency('monthly')}
                    className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300"
                  />
                </div>
                <div>
                  <p className="text-lg font-bold">$47/mo</p>
                  <p className="text-xs text-gray-500">Less than $1.57/day</p>
                  <p className="text-xs mt-2"><span className="text-amber-500">â˜…â˜…â˜…â˜…â˜…</span> <span className="text-gray-600">|</span> <span className="text-gray-600">4000+ Reviews</span></p>
                </div>
              </div>
              
              {/* Annual Option */}
              <div
                className={`border ${
                  selectedFrequency === 'annual' ? 'border-blue-500 border-2' : 'border-gray-300'
                } rounded-lg p-3 md:p-4 cursor-pointer hover:border-blue-400 transition-colors relative`}
                onClick={() => setSelectedFrequency('annual')}
              >
                <div className="absolute -top-2 -right-2 bg-green-500 text-white text-xs font-bold py-1 px-2 rounded">
                  BEST VALUE
                </div>
                <div className="flex justify-between items-start mb-2">
                  <div>
                    <h3 className="font-medium text-gray-900">Annual</h3>
                    <p className="text-sm text-gray-500">Auto-renews yearly</p>
                    <p className="text-xs text-green-600 font-semibold mt-1">Save 30%</p>
                  </div>
                  <input
                    type="radio"
                    name="plan"
                    checked={selectedFrequency === 'annual'}
                    onChange={() => setSelectedFrequency('annual')}
                    className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300"
                  />
                </div>
                <div>
                  <p className="text-lg font-bold">$397/yr</p>
                  <p className="text-xs text-gray-500">Less than $1.09/day</p>
                  <p className="text-xs mt-2"><span className="text-amber-500">â˜…â˜…â˜…â˜…â˜…</span> <span className="text-gray-600">|</span> <span className="text-gray-600">4000+ Reviews</span></p>
                </div>
              </div>
            </div>
          </div>
          
          {/* Order Summary */}
          <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6 md:mb-8">
            <h3 className="font-medium text-gray-900 mb-3">Order Summary</h3>
            <div className="flex justify-between mb-2">
              <p className="text-gray-600">{priceInfo.frequency === 'monthly' ? 'Monthly' : 'Annual'} Plan:</p>
              <p className="font-medium">${priceInfo.discountPrice}</p>
            </div>
            {priceInfo.frequency === 'annual' && (
              <div className="flex justify-between mb-2 text-green-600 text-sm">
                <p>You save:</p>
                <p>$167</p>
              </div>
            )}
            {isAmbassador && (
              <div className="flex justify-between mb-2">
                <p className="text-gray-600">Ambassador Program (Annual):</p>
                <p className="font-medium">$10.00</p>
              </div>
            )}
            <div className="flex justify-between mb-2">
              <p className="text-gray-600">{isAmbassador ? 'No Trial Period' : '5-Day Free Trial'}:</p>
              <p className="font-medium">{isAmbassador ? 'N/A' : '$0.00'}</p>
            </div>
            <div className="border-t border-gray-200 my-2 pt-2"></div>
            <div className="flex justify-between">
              <p className="font-medium">Due today:</p>
              <p className="font-bold">{isAmbassador ? `$${priceInfo.totalPrice.toFixed(2)}` : '$0.00'}</p>
            </div>
            <div className="mt-1 text-xs text-gray-500 flex items-center">
              <svg className="h-3 w-3 mr-1 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              {isAmbassador ? (
                <span>Charged immediately: ${priceInfo.totalPrice.toFixed(2)} {priceInfo.frequency === 'monthly' ? 'per month' : 'per year'}</span>
              ) : (
                <span>After trial, ${priceInfo.totalPrice} {priceInfo.frequency === 'monthly' ? 'per month' : 'per year'}</span>
              )}
            </div>
          </div>
          
          {/* Checkout Form */}
          <Elements stripe={stripePromise}>
            <CheckoutForm 
              selectedFrequency={selectedFrequency}
              isAmbassador={isAmbassador}
              setIsAmbassador={setIsAmbassador}
            />
          </Elements>
        </div>
      </div>
      
      {/* Right Section (Image) */}
      <div className="hidden lg:block w-full xl:w-2/5 min-h-screen relative overflow-hidden">
        {/* Gradient Background with Animation */}
        <div 
          className="absolute inset-0 w-full h-full z-0"
          style={{
            position: 'relative',
            width: '100%',
            height: '100%',
            overflow: 'hidden'
          }}
        >
          <div 
            style={{
              position: 'absolute',
              top: 0,
              left: 0,
              width: '100%',
              height: '100%',
              opacity: 0,
              backgroundImage: 'url(/gradients/gradient1.jpg)',
              backgroundSize: 'cover',
              animation: 'fadeInOut 20s infinite 0s',
              zIndex: 10,
            }}
          />
          <div 
            style={{
              position: 'absolute',
              top: 0,
              left: 0,
              width: '100%',
              height: '100%',
              opacity: 0,
              backgroundImage: 'url(/gradients/gradient2.jpg)',
              backgroundSize: 'cover',
              animation: 'fadeInOut 20s infinite 5s',
              zIndex: 10,
            }}
          />
          <div 
            style={{
              position: 'absolute',
              top: 0,
              left: 0,
              width: '100%',
              height: '100%',
              opacity: 0,
              backgroundImage: 'url(/gradients/gradient3.jpg)',
              backgroundSize: 'cover',
              animation: 'fadeInOut 20s infinite 10s',
              zIndex: 10,
            }}
          />
          <div 
            style={{
              position: 'absolute',
              top: 0,
              left: 0,
              width: '100%',
              height: '100%',
              opacity: 0,
              backgroundImage: 'url(/gradients/gradient4.jpg)',
              backgroundSize: 'cover',
              animation: 'fadeInOut 20s infinite 15s',
              zIndex: 10,
            }}
          />
          <style jsx>{`
            @keyframes fadeInOut {
              0% { opacity: 0; }
              5% { opacity: 0; }
              15% { opacity: 1; }
              45% { opacity: 1; }
              55% { opacity: 0; }
              100% { opacity: 0; }
            }
          `}</style>
        </div>

        {/* Semi-transparent panel */}
        <div className="relative z-20 h-full w-full p-8 sm:p-12 text-white flex flex-col justify-between">
          <div className="bg-black/30 rounded-2xl p-6 backdrop-blur-md">
            <h2 className="text-2xl font-bold mb-4">The Christian Prayer App</h2>
            
            <div className="mb-8">
              <div className="font-semibold text-lg mb-2">What you get:</div>
              <ul className="space-y-3">
                <li className="flex items-start">
                  <span className="mr-3 text-green-300">âœ“</span>
                  <span>Daily structured prayer guides</span>
                </li>
                <li className="flex items-start">
                  <span className="mr-3 text-green-300">âœ“</span>
                  <span>Prayer tracking with insights</span>
                </li>
                <li className="flex items-start">
                  <span className="mr-3 text-green-300">âœ“</span>
                  <span>Community prayer circles</span>
                </li>
                <li className="flex items-start">
                  <span className="mr-3 text-green-300">âœ“</span>
                  <span>Scripture-based meditations</span>
                </li>
                <li className="flex items-start">
                  <span className="mr-3 text-green-300">âœ“</span>
                  <span>Prayer reminders & journals</span>
                </li>
              </ul>
            </div>
            
            <div className="text-sm opacity-90 italic">
              "This app has transformed my prayer life. The daily structure and community features keep me accountable."
              <div className="mt-2 font-semibold not-italic">â€” Sarah M.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
